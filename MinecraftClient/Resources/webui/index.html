<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.css">
<style>
    html, body { margin: 0; padding: 0; height: 100%; width: 100%; }
    .title {
        font-size: 30px;
    }
    .logo {
        width: 25px;
        height: 25px;
    }
    #console {
        width: 850px;
        height: auto;
        float: right;
    }
    #console #chat {
        width: 850px;
        height: 500px;
        border: 2px black solid;
        overflow-y: scroll;
        margin: auto;
        font-family: monospace;
        background-color: black;
        color: white;
        font-size: 14px;
    }
    #console #chat li {
        list-style: none;
        padding: 1px;
    }
    #console input[type=text]{
        width: 100%;
        font-family: monospace;
        font-size: 14px;
        background-color: black;
        color: white;
    }
    #console .input {
        display: block;
        overflow: hidden;
        padding-right:10px;
    }
    #console input[type=button]{
        float: right;
    }
</style>
<style>
    .gray{color:gray;}
    .dark-blue{color:darkblue;}
    .dark-green{color:darkgreen;}
</style>
</head>

<body>
    <span class="title"><img src="favicon.ico" class="logo">Minecraft Console Client WebUI</span>
    <div id="console">
        <div id="chat"></div>
        <input type="button" onclick="submit()" value="Enter">
        <span class="input"><input id="input" type="text" onkeypress="submit(event)" placeholder="> Type your message and press Enter"></span>
    </div>
    <div id="log"></div>

<!-- Taken from https://github.com/ChrisHouston/s -->
<script type="text/javascript">
    function s(selectors){
        return document.querySelector(selectors);
    }
</script>
<script type="text/javascript">
    let lastHeartBeat = Date.now();
    let heartBeatTimerID;
    let maxRetry = 3;
    let retry = maxRetry;
    let host = location.host;
    let ws; // = new WebSocket("ws://" + host + "/data");
    if (!host){ // html file is opened directly
        host = "localhost:8080";
    }
    wsConnect("ws://" + host + "/data");

    function submit(event){
        if (event){
            if (event.keyCode !== 13) return;
        }
        let text = s("#input").value;
        ws.send(toServer("input", text));
        appendChat(">" + text + "\n");
        s("#input").value = "";
    }

    function appendChat(line){
        lines = line.split("\n");
        lines.forEach(l=>{
            if (l === "" || l === "\n") return;
            //let el = document.createElement("li");
            //el.appendChild(document.createTextNode(l))
            s("#chat").appendChild(getColored(l));
            scrollToBottom("chat");
        });
        if (s("#chat").childElementCount > 100){
            for (let i = 0; i < (s("#chat").childElementCount - 100); i++){
                s("#chat").children[0].remove();
            }
        }
    }

    function scrollToBottom(id){
        document.getElementById(id).scrollTop = document.getElementById(id).scrollHeight
    }

    function toServer(action, payload){
        return JSON.stringify({"action":action, "data": payload});
    }

    function fromServer(rawData){
        return JSON.parse(rawData);
    }

    let colorCodeReg = new RegExp(String.fromCharCode(167) + ".", "gm"); // Minecraft color code
    function removeColorChar(str){
        return str.replace(colorCodeReg, "");
    }

    function getColored(str){
        let colored = "";
        let isCode = false;
        let hasColorBefore = false;
        let el = document.createElement("div");
        for(let i = 0; i < str.length; i++){
            if (isCode){
                let color = colorCodeToColor(str[i]);
                colored += `<span style="color:${color};">`;
                isCode = false;
                hasColorBefore = true;
                continue;
            }
            if (str[i] != String.fromCharCode(167)){
                colored += escapeHtml(str[i]);
            }else{
                isCode = true;
                if (hasColorBefore){
                    colored += "</span>";
                    hasColorBefore = false;
                }
            }
        }
        if (hasColorBefore){
            colored += "</span>";
        }
        el.innerHTML = colored;
        return el;
    }

    function colorCodeToColor(code){ // without that sign
        switch(code){
            case '0': return "gray"; // Should be black but it is not visable
            case '1': return "darkblue";
            case '2': return "darkgreen";
            case '3': return "darkcyan";
            case '4': return "darkred";
            case '5': return "darkmagenta";
            case '6': return "darkyellow";
            case '7': return "gray";
            case '8': return "darkgray";
            case '9': return "blue";
            case 'a': return "green";
            case 'b': return "cyan";
            case 'c': return "red";
            case 'd': return "magenta";
            case 'e': return "yellow";
            case 'f': return "white";
            case 'r': return "white";
            default: return "while";
        }
    }

    function escapeHtml(unsafe) {
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    function wsConnect(host){
        ws = new WebSocket(host);
        ws.onmessage = wsOnMessage;
        ws.onopen = wsOnOpen;
        ws.onclose = wsOnClose;
    }

    function wsOnMessage(e) {
        console.log(e);
        let json = fromServer(e.data);
        let action = json.action;
        let data = json.data;
        
        switch (action){
            case "chat":{
                appendChat(data);
                break;
            }
            case "pong":{
                onHeartBeat();
                break;
            }
            default: {
                if (data) s("#log").innerText += data + "\n";
            }
        }
    }

    function wsOnOpen(e) {
        console.log("Connected to MCC");
        ws.send(toServer("none", "Connected"));
        doHeartBeat();
        heartBeatTimerID = setInterval(()=>{
            doHeartBeat();
        }, 25000);
        retry = maxRetry;
    }

    function wsOnClose(){
        clearInterval(heartBeatTimerID);
        appendChat("Connection to MCC lost. Wait 5 seconds before reconnect.");
        if (retry <= 0){
            appendChat("Retry attempt exceeded.");
            appendChat("Not able to reconnect. Please check your MCC client status and refresh the page");
            alert("Not able to reconnect.\nPlease check your MCC client status and refresh the page");
            return;
        }else{
            setTimeout(()=>{
                appendChat("Reconnecting...");
                wsConnect("ws://" + host + "/data");
                retry--;
            }, 5000);
        }
    }

    function doHeartBeat(){
        console.log("do ping");
        if ((Date.now() - lastHeartBeat) > 30000){
            ws.close();
        }
        ws.send(toServer("ping", ""));
    }

    function onHeartBeat(){
        console.log("on ping");
        lastHeartBeat = Date.now();
    }
</script>
</body>
</html>